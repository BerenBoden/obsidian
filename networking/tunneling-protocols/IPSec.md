IPSec was designed for providing authentication and encryption over the internet. It operates at layer 3, and secures all applications that operate in the layers above it. IPSec supports both IPv4 and IPv6 and it is the standard for VPNs on the internet.

IPSec has two main protocols; AH (Authentication Header) and ESP (Encapsulating Security Payload). AH is used for authentication only, ESP is used for encryption and authentication, IPSec has two modes for which each of these can be used.

**AH**
The Authentication Header is added to the packet and it creates a hash over the following fields:
- Immutable fields in the IP header (e.g., Source and Destination IP)
- AH header fields (e.g., Security Parameter Index and Sequence Number)
- The data payload

The Authentication Header (AH) protocol within IPSec is not compatible with Network Address Translation (NAT) for a specific reason: AH is designed to provide connection integrity by authenticating packets. It does this by adding an AH header to the packet, which includes a hash that hashes Immutable fields of the original IP packet. When the packet reaches its destination, a new hash is generated and compared with the sent hash to verify the packet's integrity.

NAT modifies the source or destination IP addresses as packets pass through a router or firewall. When NAT changes these addresses, the hash generated by AH becomes invalid, as it was based on the original, unaltered packet. Consequently, the destination will consider the packet as tampered, even if it has only undergone legitimate NAT.

Here is an IP packet being authenticated with an AH Header.
![image](https://beren-obsidian-images.imgix.net/0f6142360df2421f62b78ce8b9aba88b.png)

**ESP**
Encapsulating Security Payload (ESP) is another protocol within IPSec designed for providing confidentiality, integrity, and authenticity of data. Unlike AH, which authenticates the entire packet (including the header), ESP only authenticates the data payload, not the mutable fields in the IP header. Common encryption algorithms used are AES and 3DES.

This makes ESP more flexible and compatible with NAT. Since NAT alters the IP header but leaves the payload untouched, the ESP authentication can still verify that the payload hasn't been tampered with, even after the packet has passed through a NAT device.

Additionally, ESP often encapsulates the original packet, adding a new header. NAT can modify this new outer header without affecting the original packet or its ESP authentication.
![image](https://beren-obsidian-images.imgix.net/97d5fa52c9d860fbd12d4fbe536788f8.png)
